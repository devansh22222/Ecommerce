# ----------------------------------------------------------
# GitLab CI/CD for React + Vite Project
# ----------------------------------------------------------

stages:
  - validate
  - build
  - test
  - deploy

# Stage 1: Validate (checks for missing tags, syntax, etc.)
validate-code:
  stage: validate
  image: node:18
  script:
    - npm ci
    - echo "Running ESLint validation..."
    # ESLint will catch syntax issues like unclosed tags or blocks
    - npx eslint . --ext .js,.jsx --max-warnings=0
  only:
    - main

# Stage 2: Build (builds production files)
build-vite:
  stage: build
  image: node:18
  script:
    - npm ci
    - echo "Building Vite project..."
    - npm run build
  artifacts:
    paths:
      - dist
  only:
    - main

# Stage 3: Test (runs ESLint again to ensure clean code)
test-lint:
  stage: test
  image: node:18
  script:
    - npm ci
    - echo "Running lint test..."
    - npx eslint src --ext .js,.jsx --max-warnings=0
  only:
    - main

# Stage 4: Deploy (to Railway)
deploy-production:
  stage: deploy
  image: node:18
  before_script:
    - npm install -g railway
  script:
    - echo "Deploying to Railway..."
    - railway up --service "$RAILWAY_SERVICE_ID" -d
  environment:
    name: production
    url: $RAILWAY_PUBLIC_URL
  only:
    - main
  when: manual
