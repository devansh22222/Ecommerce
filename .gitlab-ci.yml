# ----------------------------------------------------------
# GitLab CI/CD Pipeline for Ecommerce Project
# Frontend (React + Vite), Admin (React + Vite), Backend (Node + Express)
# ----------------------------------------------------------

stages:
  - validate
  - build
  - test
  - deploy

########################
# 1ï¸âƒ£ VALIDATE STAGE
########################
validate-code:
  stage: validate
  image: node:18
  script:
    # Validate Admin
    - echo "ğŸ” Running ESLint validation for admin..."
    - cd admin
    - npm ci
    - npx eslint . --ext .js,.jsx --max-warnings=0
    - cd ..

    # Validate Frontend
    - echo "ğŸ” Running ESLint validation for frontend..."
    - cd frontend
    - npm ci
    - npx eslint . --ext .js,.jsx --max-warnings=0
    - cd ..

    # Validate Backend
    - echo "ğŸ” Running ESLint validation for backend..."
    - cd backend
    - npm ci
    - npx eslint . --ext .js --max-warnings=0
  only:
    - main

########################
# 2ï¸âƒ£ BUILD STAGE
########################
build-apps:
  stage: build
  image: node:18
  script:
    # Build Admin App
    - echo "ğŸ—ï¸ Building admin app..."
    - cd admin
    - npm ci
    - npm run build
    - cd ..

    # Build Frontend App
    - echo "ğŸ—ï¸ Building frontend app..."
    - cd frontend
    - npm ci
    - npm run build
  artifacts:
    paths:
      - admin/dist
      - frontend/dist
  only:
    - main

########################
# 3ï¸âƒ£ TEST STAGE
########################
test-all:
  stage: test
  image: node:18
  script:
    # Backend Lint Test
    - echo "ğŸ§ª Testing backend..."
    - cd backend
    - npm ci
    - npx eslint . --ext .js --max-warnings=0
    - cd ..

    # Frontend Lint Test
    - echo "ğŸ§ª Testing frontend..."
    - cd frontend
    - npm ci
    - npx eslint . --ext .js,.jsx --max-warnings=0
    - cd ..

    # Admin Lint Test
    - echo "ğŸ§ª Testing admin..."
    - cd admin
    - npm ci
    - npx eslint . --ext .js,.jsx --max-warnings=0
  only:
    - main

########################
# 4ï¸âƒ£ DEPLOY STAGE
########################
deploy-to-render:
  stage: deploy
  image: curlimages/curl:latest
  script:
    - echo "ğŸš€ Triggering Render Deployments..."
    - 'curl -X POST "$RENDER_DEPLOY_BACKEND_URL"'
    - 'curl -X POST "$RENDER_DEPLOY_FRONTEND_URL"'
    - 'curl -X POST "$RENDER_DEPLOY_ADMIN_URL"'
  environment:
    name: production
  only:
    - main
  when: on_success
